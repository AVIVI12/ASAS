<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Royale v9 - Pure Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #0d1117; color: #e6edf3; }
        .chat-container { max-width: 800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .message-list { flex: 1; overflow-y: auto; padding: 1.5rem; scroll-behavior: smooth; }
        .bubble { max-width: 85%; padding: 0.8rem 1.2rem; border-radius: 1rem; margin-bottom: 1rem; line-height: 1.6; }
        .user-bubble { background: #1f6feb; border-bottom-right-radius: 4px; align-self: flex-start; }
        .ai-bubble { background: #21262d; border: 1px solid #30363d; border-bottom-left-radius: 4px; align-self: flex-end; }
        .error-bubble { background: #442726; border: 1px solid #8e3533; align-self: flex-end; }
        
        #sidebar { 
            position: fixed; top: 0; right: 0; height: 100%; width: 280px; 
            background: #161b22; z-index: 1000; transform: translateX(100%);
            transition: transform 0.3s ease; border-left: 1px solid #30363d;
        }
        #sidebar.open { transform: translateX(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 999; }
        
        pre { background: #000 !important; padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 10px 0; direction: ltr; }
        .loading { opacity: 0.5; font-style: italic; }
        .history-item:hover .delete-btn { opacity: 1; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="overflow-hidden">

    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="flex flex-col p-4 shadow-2xl">
        <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-800">
            <h2 class="font-bold">×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×•×ª</h2>
            <button onclick="toggleSidebar()" class="text-xl">âœ•</button>
        </div>
        <button onclick="createNewChat()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition mb-4 shadow-lg">+ ×©×™×—×” ×—×“×©×”</button>
        
        <div id="history-list" class="flex-grow overflow-y-auto space-y-2 mb-4"></div>

        <button onclick="clearAllHistory()" class="w-full py-2 text-xs text-red-500 hover:bg-red-900/20 border border-red-900/30 rounded-lg transition">××—×§ ×”×›×œ</button>
    </aside>

    <div class="chat-container">
        <!-- Header -->
        <header class="p-3 bg-[#161b22] border-b border-[#30363d] flex items-center justify-between gap-2 shadow-md">
            <div class="flex items-center gap-2">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-800 rounded-lg text-xl" title="×ª×¤×¨×™×˜">â˜°</button>
                <h1 class="font-bold text-blue-400 hidden sm:block">Gemini Royale</h1>
            </div>
            <div class="flex items-center gap-2 flex-grow max-w-xl">
                <input type="password" id="api-key" placeholder="API Key" class="bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs w-24 md:w-32 focus:border-blue-500 outline-none">
                <input type="text" id="proxy-url" placeholder="×¤×¨×•×§×¡×™ (××•×¤×¦×™×•× ×œ×™)" class="bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs flex-grow outline-none focus:border-blue-500">
                <select id="model-select" class="bg-gray-900 border border-gray-700 rounded px-2 py-1.5 text-xs outline-none">
                    <option value="gemini-1.5-pro-002" selected>Gemini 2.5 Pro</option>
                    <option value="gemini-1.5-flash-002">Gemini 2.5 Flash</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                </select>
            </div>
        </header>

        <!-- Messages Area -->
        <main id="chat-window" class="message-list flex flex-col bg-[#0d1117]">
            <!-- Welcome View if No Chat -->
            <div id="welcome-msg" class="m-auto text-center opacity-20">
                <div class="text-7xl mb-4">âœ¨</div>
                <p>×”×ª×—×œ ×©×™×—×” ×—×“×©×”</p>
            </div>
        </main>

        <div id="previews" class="px-4 py-2 flex gap-2 hidden bg-[#161b22]"></div>

        <footer class="p-4 bg-[#161b22] border-t border-[#30363d]">
            <div class="max-w-[800px] mx-auto flex items-end gap-3">
                <div class="flex-grow bg-[#0d1117] rounded-2xl border border-[#30363d] relative">
                    <textarea id="user-input" rows="1" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." class="w-full bg-transparent p-4 pr-12 outline-none resize-none max-h-60"></textarea>
                    <button onclick="document.getElementById('file-input').click()" class="absolute left-3 bottom-3 text-gray-400 hover:text-blue-400 p-1">ğŸ“</button>
                    <input type="file" id="file-input" hidden multiple accept="image/*" onchange="handleFiles(this)">
                </div>
                <button id="send-btn" onclick="handleSend()" class="bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-2xl shadow-xl transition-all active:scale-95">×©×œ×—</button>
            </div>
        </footer>
    </div>

    <script>
        let currentChatId = null;
        let db = JSON.parse(localStorage.getItem('gem_royale_v9') || '{}');
        let sessionFiles = [];

        // UI Helpers
        const keyField = document.getElementById('api-key');
        const prxField = document.getElementById('proxy-url');
        keyField.value = localStorage.getItem('gem_key_v9') || '';
        prxField.value = localStorage.getItem('gem_proxy_v9') || '';
        keyField.oninput = () => localStorage.setItem('gem_key_v9', keyField.value.trim());
        prxField.oninput = () => localStorage.setItem('gem_proxy_v9', prxField.value.trim());

        function saveDB() { localStorage.setItem('gem_royale_v9', JSON.stringify(db)); }

        function toggleSidebar() {
            const open = document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').style.display = open ? 'block' : 'none';
        }

        function refreshHistoryUI() {
            const list = document.getElementById('history-list');
            const sorted = Object.keys(db).sort((a,b) => b-a);
            
            if (sorted.length === 0) {
                list.innerHTML = '<div class="text-center opacity-20 text-xs py-10">××™×Ÿ ×”×™×¡×˜×•×¨×™×”</div>';
                return;
            }

            list.innerHTML = sorted.map(id => `
                <div onclick="switchChat('${id}')" class="history-item p-3 rounded-xl hover:bg-gray-800 cursor-pointer transition flex items-center justify-between group ${id === currentChatId ? 'bg-gray-800 ring-1 ring-blue-500' : ''}">
                    <div class="flex flex-col overflow-hidden">
                        <span class="truncate text-sm font-bold text-gray-200">${db[id].title || '×©×™×—×” ×—×“×©×”'}</span>
                        <span class="text-[10px] opacity-40 text-gray-400">${new Date(parseInt(id)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <button onclick="deleteChat('${id}', event)" class="delete-btn p-1.5 hover:bg-red-500/20 rounded-lg text-red-500 text-xs">âœ•</button>
                </div>
            `).join('');
        }

        function createNewChat() {
            const id = Date.now().toString();
            db[id] = { title: "×©×™×—×” ×—×“×©×”", messages: [] };
            currentChatId = id;
            saveDB();
            renderMessages();
            refreshHistoryUI();
            if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }

        function switchChat(id) {
            currentChatId = id;
            renderMessages();
            refreshHistoryUI();
            if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }

        function deleteChat(id, event) {
            event.stopPropagation();
            if (!confirm('×œ××—×•×§ ×©×™×—×” ×–×•?')) return;
            delete db[id];
            if (currentChatId === id) currentChatId = null;
            saveDB();
            refreshHistoryUI();
            renderMessages();
        }

        function clearAllHistory() {
            if (!confirm('×œ××—×•×§ ×”×›×œ?')) return;
            db = {};
            currentChatId = null;
            saveDB();
            refreshHistoryUI();
            renderMessages();
        }

        function handleFiles(input) {
            Array.from(input.files).forEach(f => {
                const r = new FileReader();
                r.onload = (e) => {
                    sessionFiles.push({ mime: f.type, data: e.target.result.split(',')[1], full: e.target.result });
                    drawPreviews();
                };
                r.readAsDataURL(f);
            });
        }

        function drawPreviews() {
            const container = document.getElementById('previews');
            container.classList.toggle('hidden', sessionFiles.length === 0);
            container.innerHTML = sessionFiles.map((f, i) => `
                <div class="relative"><img src="${f.full}" class="h-12 w-12 rounded border border-gray-700 object-cover shadow-sm">
                <button onclick="sessionFiles.splice(${i},1);drawPreviews()" class="absolute -top-1 -right-1 bg-red-600 rounded-full w-4 h-4 text-[10px] flex items-center justify-center">âœ•</button></div>
            `).join('');
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const key = keyField.value.trim();
            const proxy = prxField.value.trim();

            if (!text && sessionFiles.length === 0) return;
            if (!key) return alert("×”×–×Ÿ ××¤×ª×— API");

            // ×™×¦×™×¨×ª ×©×™×—×” ×× ××™×Ÿ
            if (!currentChatId || !db[currentChatId]) {
                currentChatId = Date.now().toString();
                db[currentChatId] = { title: text ? text.substring(0, 25) : "×ª××•× ×”", messages: [] };
            }

            // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×× ×–×• ×”×•×“×¢×” ×¨××©×•× ×”
            if (db[currentChatId].title === "×©×™×—×” ×—×“×©×”" && text) {
                db[currentChatId].title = text.substring(0, 25);
            }

            const userMsg = { role: 'user', parts: [{ text: text || "× ×ª×— ×§×‘×¦×™×" }] };
            sessionFiles.forEach(f => userMsg.parts.push({ inline_data: { mime_type: f.mime, data: f.data } }));
            
            db[currentChatId].messages.push(userMsg);
            
            // ××™×¤×•×¡ ×××©×§ ××™×™×“×™
            sessionFiles = []; drawPreviews(); input.value = ''; input.rows = 1;
            renderMessages();
            refreshHistoryUI();
            saveDB();

            // ×‘×•×¢×ª ×—×©×™×‘×”
            db[currentChatId].messages.push({ role: 'model', parts: [{ text: '×’\'×™××™× ×™ ×—×•×©×‘...' }], loading: true });
            renderMessages();

            try {
                const model = document.getElementById('model-select').value;
                const url = proxy ? `${proxy}${proxy.includes('?') ? '&' : '?'}key=${key}&model=${model}` : 
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: proxy ? {} : { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: db[currentChatId].messages.filter(m => !m.loading).map(m => ({role: m.role, parts: m.parts})) })
                });

                const data = await response.json();
                db[currentChatId].messages = db[currentChatId].messages.filter(m => !m.loading);

                if (data.error) throw new Error(data.error.message);
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                db[currentChatId].messages.push({ role: 'model', parts: [{ text: aiResponse }] });

            } catch (err) {
                db[currentChatId].messages = db[currentChatId].messages.filter(m => !m.loading);
                db[currentChatId].messages.push({ role: 'model', parts: [{ text: "×©×’×™××”: " + err.message }], error: true });
            } finally {
                saveDB();
                renderMessages();
                refreshHistoryUI();
            }
        }

        function renderMessages() {
            const win = document.getElementById('chat-window');
            if (!currentChatId || !db[currentChatId]) {
                win.innerHTML = '<div class="m-auto opacity-20 text-center text-8xl">âœ¨</div>';
                return;
            }

            const messages = db[currentChatId].messages;
            if (messages.length === 0) {
                win.innerHTML = '<div class="m-auto opacity-20 text-center">×©×™×—×” ×—×“×©×”...</div>';
                return;
            }

            win.innerHTML = messages.map(m => {
                const isUser = m.role === 'user';
                let content = '';
                m.parts.forEach(p => {
                    if (p.inline_data) content += `<img src="data:${p.inline_data.mime_type};base64,${p.inline_data.data}" class="max-w-xs rounded-xl mb-3 border border-gray-800">`;
                    if (p.text) {
                        const isRtl = /[\u0590-\u05FF]/.test(p.text);
                        const html = isUser ? p.text.replace(/\n/g, '<br>') : marked.parse(p.text);
                        content += `<div dir="${isRtl ? 'rtl' : 'ltr'}">${html}</div>`;
                    }
                });
                return `
                    <div class="flex flex-col ${isUser ? 'items-start' : 'items-end'} w-full animate-in fade-in duration-300">
                        <div class="bubble ${isUser ? 'user-bubble' : (m.error ? 'error-bubble' : 'ai-bubble')} ${m.loading ? 'loading' : ''}">
                            <div class="text-[9px] font-bold opacity-30 mb-1 uppercase tracking-tighter">${isUser ? 'ME' : 'GEMINI AI'}</div>
                            <div class="markdown-body">${content}</div>
                        </div>
                    </div>
                `;
            }).join('');
            win.scrollTop = win.scrollHeight;
        }

        // Init
        refreshHistoryUI();
        const keys = Object.keys(db).sort((a,b) => b-a);
        if (keys.length > 0) {
            currentChatId = keys[0];
            renderMessages();
        }

        document.getElementById('user-input').oninput = function() {
            this.rows = 1; this.rows = Math.min(Math.floor(this.scrollHeight / 24), 8);
        };
        document.getElementById('user-input').onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
        };
    </script>
</body>
</html>