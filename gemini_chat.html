<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini Royale v11</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Assistant', sans-serif; background:#0d1117; color:#e6edf3; }
.bubble { max-width:85%; padding:12px 16px; border-radius:16px; }
.user { background:#1f6feb; border-bottom-right-radius:4px; }
.ai { background:#21262d; border:1px solid #30363d; border-bottom-left-radius:4px; }
.error { background:#442726; border:1px solid #8e3533; }
pre { background:#000; padding:1rem; border-radius:8px; overflow-x:auto; direction:ltr; }
</style>
</head>

<body class="h-screen flex flex-col">

<header class="p-3 bg-[#161b22] border-b border-[#30363d] flex gap-2 items-center">
<input type="password" id="apiKey" placeholder="API Key"
 class="bg-gray-900 border border-gray-700 rounded px-3 py-2 text-xs w-40">

<select id="model"
 class="bg-gray-900 border border-gray-700 rounded px-3 py-2 text-xs">
<option value="gemini-3-flash-preview" selected>Gemini 3 Flash (Preview)</option>
<option value="gemini-3-pro-preview">Gemini 3 Pro (Preview)</option>
<option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
<option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
<option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
</select>

<button id="newChat"
 class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-sm">
שיחה חדשה
</button>
</header>

<main id="chat"
 class="flex-1 overflow-y-auto p-6 flex flex-col gap-4"></main>

<footer class="p-4 bg-[#161b22] border-t border-[#30363d] flex gap-3">
<textarea id="input"
 rows="1"
 placeholder="כתוב הודעה..."
 class="flex-1 bg-[#0d1117] border border-[#30363d] rounded-2xl p-4 resize-none max-h-40"></textarea>

<button id="send"
 class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-2xl">
שלח
</button>
</footer>

<script>
(() => {

const STORAGE = "gemini_royale_v11";
const KEY_STORAGE = "gemini_key_v11";

let state = {
    chats: JSON.parse(localStorage.getItem(STORAGE) || "{}"),
    current: null,
    controller: null
};

const el = id => document.getElementById(id);
const chatEl = el("chat");

function save() {
    localStorage.setItem(STORAGE, JSON.stringify(state.chats));
}

function sanitize(str) {
    return str.replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function createChat() {
    const id = Date.now().toString();
    state.chats[id] = { messages: [] };
    state.current = id;
    save();
    render();
}

function render() {
    chatEl.innerHTML = "";
    if (!state.current) return;

    const messages = state.chats[state.current].messages;

    messages.forEach(m => {
        const wrapper = document.createElement("div");
        wrapper.className = "flex " + (m.role === "user" ? "justify-start" : "justify-end");

        const bubble = document.createElement("div");
        bubble.className = "bubble " +
            (m.role === "user" ? "user" :
            m.error ? "error" : "ai");

        m.parts.forEach(p => {
            if (p.text) {
                const div = document.createElement("div");
                div.innerHTML = m.role === "user"
                    ? sanitize(p.text).replace(/\n/g,"<br>")
                    : marked.parse(sanitize(p.text));
                bubble.appendChild(div);
            }
        });

        wrapper.appendChild(bubble);
        chatEl.appendChild(wrapper);
    });

    chatEl.scrollTop = chatEl.scrollHeight;
}

async function sendMessage() {

    const text = el("input").value.trim();
    if (!text) return;

    const key = el("apiKey").value.trim();
    if (!key) return alert("הזן API Key");

    if (!state.current) createChat();

    const chat = state.chats[state.current];

    chat.messages.push({
        role: "user",
        parts: [{ text }]
    });

    el("input").value = "";
    render();
    save();

    chat.messages.push({
        role: "model",
        parts: [{ text: "טוען..." }],
        loading: true
    });
    render();

    if (state.controller) state.controller.abort();
    state.controller = new AbortController();

    try {

        const model = el("model").value;

        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${key}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: chat.messages
                        .filter(m => !m.loading)
                        .map(m => ({ role:m.role, parts:m.parts }))
                }),
                signal: state.controller.signal
            }
        );

        if (!response.ok)
            throw new Error("HTTP " + response.status);

        const data = await response.json();

        const reply =
            data.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!reply)
            throw new Error("תגובה לא תקינה");

        chat.messages = chat.messages.filter(m => !m.loading);

        chat.messages.push({
            role: "model",
            parts: [{ text: reply }]
        });

    } catch (err) {

        chat.messages = chat.messages.filter(m => !m.loading);

        chat.messages.push({
            role: "model",
            parts: [{ text: "שגיאה: " + err.message }],
            error: true
        });

    }

    save();
    render();
}

el("send").onclick = sendMessage;
el("newChat").onclick = createChat;

el("input").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

el("apiKey").value = localStorage.getItem(KEY_STORAGE) || "";
el("apiKey").oninput = e =>
    localStorage.setItem(KEY_STORAGE, e.target.value);

createChat();

})();
</script>

</body>
</html>
