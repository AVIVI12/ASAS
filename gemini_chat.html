<script>
/* ========= CONFIG ========= */

const API_BASE = "https://generativelanguage.googleapis.com/v1beta/models";

const FALLBACK_MODELS = [
  "gemini-2.0-flash",
  "gemini-1.5-flash-latest",
  "gemini-1.5-flash"
];

/* ========= STATE ========= */

let state = {
  chats: JSON.parse(localStorage.getItem("gemini_chats") || "{}"),
  currentChatId: null,
  apiKey: localStorage.getItem("gemini_api_key") || "",
  proxy: localStorage.getItem("gemini_proxy") || ""
};

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const historyEl = document.getElementById("chatHistory");
const proxyInput = document.getElementById("proxyServer");
const apiInput = document.getElementById("apiKey");

apiInput.value = state.apiKey;
proxyInput.value = state.proxy;

/* ========= STATE ========= */

function saveState() {
  localStorage.setItem("gemini_chats", JSON.stringify(state.chats));
  localStorage.setItem("gemini_api_key", state.apiKey);
  localStorage.setItem("gemini_proxy", state.proxy);
}

function createNewChat() {
  const id = Date.now().toString();
  state.chats[id] = [];
  state.currentChatId = id;
  saveState();
  renderChat();
  renderHistory();
}

function loadState() {
  const ids = Object.keys(state.chats);
  state.currentChatId = ids.length ? ids[ids.length - 1] : null;
  if (!state.currentChatId) createNewChat();
  renderChat();
  renderHistory();
}

/* ========= UI ========= */

function renderMarkdown(el, text) {
  el.innerHTML = DOMPurify.sanitize(marked.parse(text));
}

function addMessage(role, text) {
  const wrapper = document.createElement("div");
  wrapper.className = role === "user" ? "flex justify-end" : "flex justify-start";

  const bubble = document.createElement("div");
  bubble.className =
    role === "user"
      ? "bg-blue-600 px-4 py-3 rounded-2xl max-w-[85%] shadow-lg"
      : "bg-gray-800 border border-gray-700 px-4 py-3 rounded-2xl max-w-[85%] shadow-lg";

  renderMarkdown(bubble, text);
  wrapper.appendChild(bubble);
  chatEl.appendChild(wrapper);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function renderChat() {
  chatEl.innerHTML = "";
  (state.chats[state.currentChatId] || []).forEach(m =>
    addMessage(m.role, m.content)
  );
}

function renderHistory() {
  historyEl.innerHTML = "";
  Object.keys(state.chats).sort((a,b)=>b-a).forEach(id=>{
    const btn = document.createElement("button");
    btn.className = "bg-gray-800 px-3 py-1 rounded text-xs hover:bg-gray-700";
    btn.textContent = (state.chats[id][0]?.content || "שיחה חדשה").substring(0,20);
    btn.onclick = ()=>{
      state.currentChatId = id;
      renderChat();
      renderHistory();
    };
    if(id===state.currentChatId)
      btn.classList.add("ring-2","ring-blue-500");
    historyEl.appendChild(btn);
  });
}

/* ========= API ========= */

function buildUrl(model, key) {
  let url = `${API_BASE}/${model}:generateContent?key=${key}`;

  if (!state.proxy) return url;

  if (state.proxy.includes("{url}")) {
    return state.proxy.replace("{url}", encodeURIComponent(url));
  }

  return state.proxy + encodeURIComponent(url);
}

async function tryModel(model, key, payload) {
  const url = buildUrl(model, key);

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

async function sendMessage() {
  const key = apiInput.value.trim();
  const model = document.getElementById("model").value;
  const text = inputEl.value.trim();

  if (!key) return alert("הכנס API Key");
  if (!text) return;

  state.apiKey = key;
  saveState();

  state.chats[state.currentChatId].push({role:"user",content:text});
  addMessage("user", text);
  inputEl.value="";
  inputEl.style.height="auto";

  addMessage("model","⏳ חושב...");

  const payload = {
    contents: state.chats[state.currentChatId].map(m=>({
      role: m.role==="user"?"user":"model",
      parts:[{text:m.content}]
    }))
  };

  const modelsToTry = [model, ...FALLBACK_MODELS.filter(m=>m!==model)];

  for (let m of modelsToTry) {
    try {
      const data = await tryModel(m, key, payload);
      const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!reply) throw new Error("תגובה ריקה");

      state.chats[state.currentChatId].pop(); // remove "חושב..."
      state.chats[state.currentChatId].push({role:"model",content:reply});
      renderChat();
      saveState();
      renderHistory();
      return;

    } catch (err) {
      console.warn("Model failed:", m);
    }
  }

  state.chats[state.currentChatId].pop();
  addMessage("model","❌ כל המודלים נכשלו.");
}

/* ========= EVENTS ========= */

document.getElementById("newChat").onclick = createNewChat;

inputEl.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

inputEl.oninput=function(){
  this.style.height="auto";
  this.style.height=this.scrollHeight+"px";
};

proxyInput.onchange=()=>{
  state.proxy=proxyInput.value.trim();
  saveState();
};

loadState();
</script>
