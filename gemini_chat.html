&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;he&quot; dir=&quot;rtl&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Gemini Royale âœ¨&lt;/title&gt;

    &lt;!-- Tailwind CSS --&gt;
    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
        tailwind.config = {
            darkMode: &#39;class&#39;, // ××¤×©×¨ ×œ×”×•×¡×™×£ ×ª××™×›×” ×‘××¦×‘ ×›×”×” ×‘×”××©×š ×× ×ª×¨×¦×”
            theme: {
                extend: {
                    fontFamily: {
                        &#39;assistant&#39;: [&#39;Assistant&#39;, &#39;sans-serif&#39;],
                    },
                    colors: {
                        &#39;dark-bg&#39;: &#39;#0d1117&#39;,
                        &#39;dark-surface&#39;: &#39;#161b22&#39;,
                        &#39;dark-border&#39;: &#39;#30363d&#39;,
                        &#39;primary-blue&#39;: &#39;#2188ff&#39;,
                        &#39;hover-blue&#39;: &#39;#1a73e8&#39;,
                        &#39;user-bubble&#39;: &#39;#1f6feb&#39;,
                        &#39;ai-bubble&#39;: &#39;#21262d&#39;,
                        &#39;error-bubble&#39;: &#39;#442726&#39;,
                        &#39;code-bg&#39;: &#39;#010409&#39;,
                    }
                }
            }
        }
    &lt;/script&gt;

    &lt;!-- Assistant Font --&gt;
    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;

    &lt;!-- Highlight.js for code styling --&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css&quot;&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js&quot;&gt;&lt;/script&gt; &lt;!-- ×× ×ª×¨×¦×” ×œ×ª××•×š ×‘×©×¤×•×ª ×§×•×“ × ×•×¡×¤×•×ª, ×”×•×¡×£ ×›××Ÿ --&gt;

    &lt;!-- Marked.js for Markdown parsing --&gt;
    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/marked/marked.min.js&quot;&gt;&lt;/script&gt;

    &lt;style&gt;
        body {
            font-family: &#39;Assistant&#39;, sans-serif;
            background-color: theme(&#39;colors.dark-bg&#39;);
            color: theme(&#39;colors.gray.200&#39;); /* ×¦×‘×¢ ×˜×§×¡×˜ ×‘×¨×™×¨×ª ××—×“×œ ×‘×”×™×¨ ×™×•×ª×¨ */
        }
        .bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 8px; /* ××¨×•×•×— ×‘×™×Ÿ ×‘×•×¢×•×ª */
            word-wrap: break-word; /* ×›×“×™ ×œ×× ×•×¢ ×—×¨×™×’×” ×©×œ ××™×œ×™× ××¨×•×›×•×ª */
            overflow-wrap: break-word;
        }
        .user {
            background-color: theme(&#39;colors.user-bubble&#39;);
            border-bottom-right-radius: 4px;
            color: #ffffff; /* ×¦×‘×¢ ×˜×§×¡×˜ ×œ×‘×•×¢×ª ××©×ª××© */
        }
        .ai {
            background-color: theme(&#39;colors.ai-bubble&#39;);
            border: 1px solid theme(&#39;colors.dark-border&#39;);
            border-bottom-left-radius: 4px;
            color: #e6edf3; /* ×¦×‘×¢ ×˜×§×¡×˜ ×œ×‘×•×¢×ª AI */
        }
        .error {
            background-color: theme(&#39;colors.error-bubble&#39;);
            border: 1px solid theme(&#39;colors.red.600&#39;);
            color: #f8d7da;
        }
        pre {
            background-color: theme(&#39;colors.code-bg&#39;);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            direction: ltr; /* ×§×•×“ ×ª××™×“ ××•×¦×’ ××©×××œ ×œ×™××™×Ÿ */
            margin-top: 8px;
            position: relative; /* ×¢×‘×•×¨ ×›×¤×ª×•×¨ ×”×”×¢×ª×§×” */
        }
        pre code {
            display: block;
            font-size: 0.875rem; /* sm */
            line-height: 1.5;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: theme(&#39;colors.dark-surface&#39;);
            color: theme(&#39;colors.gray.300&#39;);
            border: 1px solid theme(&#39;colors.dark-border&#39;);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem; /* xs */
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        pre:hover .copy-button {
            opacity: 1;
        }
        .chat-list-item {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            transition: background-color 0.2s ease-in-out;
        }
        .chat-list-item:hover {
            background-color: theme(&#39;colors.dark-surface&#39;);
        }
        .chat-list-item.active {
            background-color: theme(&#39;colors.dark-border&#39;);
            font-weight: 600;
        }
        .loading-indicator {
            animation: spin 1s infinite linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .api-key-input-container {
            position: relative;
            width: 200px; /* ×’×•×“×œ ×§×‘×•×¢ ×¢×‘×•×¨ ×©×“×” ×”-API Key */
        }
        .api-key-input-container input {
            width: 100%;
            padding-right: 30px; /* ××§×•× ×œ××™×™×§×•×Ÿ ×”×¢×™×Ÿ */
        }
        .toggle-password-visibility {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: theme(&#39;colors.gray.500&#39;);
            font-size: 0.9rem;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body class=&quot;h-screen flex flex-col font-assistant&quot;&gt;

    &lt;!-- Header --&gt;
    &lt;header class=&quot;p-3 bg-dark-surface border-b border-dark-border flex justify-between items-center sticky top-0 z-50&quot;&gt;
        &lt;div class=&quot;flex items-center gap-3&quot;&gt;
            &lt;h1 class=&quot;text-xl font-bold text-primary-blue&quot;&gt;Gemini Royale âœ¨&lt;/h1&gt;

            &lt;div class=&quot;api-key-input-container relative&quot;&gt;
                &lt;input type=&quot;password&quot; id=&quot;apiKey&quot; placeholder=&quot;API Key&quot;
                       class=&quot;bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs w-full text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent&quot;&gt;
                &lt;button id=&quot;toggleApiKeyVisibility&quot; class=&quot;toggle-password-visibility&quot; aria-label=&quot;×”×¦×’/×”×¡×ª×¨ API Key&quot;&gt;
                    ğŸ‘ï¸
                &lt;/button&gt;
            &lt;/div&gt;

            &lt;select id=&quot;model&quot;
                    class=&quot;bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent&quot;&gt;
                &lt;option value=&quot;gemini-2.5-flash&quot; selected&gt;Gemini 2.5 Flash (Text)&lt;/option&gt;
                &lt;option value=&quot;gemini-2.5-pro&quot;&gt;Gemini 2.5 Pro (Reasoning)&lt;/option&gt;
                &lt;option value=&quot;gemini-2.5-flash-lite&quot;&gt;Gemini 2.5 Flash Lite&lt;/option&gt;
                &lt;option value=&quot;gemini-2.5-flash-image&quot;&gt;Gemini 2.5 Flash Image&lt;/option&gt;
            &lt;/select&gt;

            &lt;button id=&quot;newChat&quot;
                    class=&quot;bg-primary-blue hover:bg-hover-blue text-white px-4 py-2 rounded-xl text-sm flex items-center gap-1 transition duration-200 ease-in-out&quot;&gt;
                &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-4 w-4&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M12 5v14m7-7H5&quot;&gt;&lt;/path&gt;&lt;/svg&gt;
                ×©×™×—×” ×—×“×©×”
            &lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;flex items-center gap-3&quot;&gt;
            &lt;span class=&quot;text-sm text-gray-400&quot;&gt;×©×™×—×•×ª ××—×¨×•× ×•×ª:&lt;/span&gt;
            &lt;div id=&quot;chatList&quot; class=&quot;flex gap-2 overflow-x-auto&quot;&gt;
                &lt;!-- Chat list items will be loaded here --&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/header&gt;

    &lt;!-- Main Chat Area --&gt;
    &lt;main id=&quot;chat&quot; class=&quot;flex-1 overflow-y-auto p-6 flex flex-col gap-4&quot;&gt;&lt;/main&gt;

    &lt;!-- Footer --&gt;
    &lt;footer class=&quot;p-4 bg-dark-surface border-t border-dark-border flex items-end gap-3 sticky bottom-0 z-50&quot;&gt;
        &lt;div class=&quot;flex-1 flex flex-col&quot;&gt;
            &lt;textarea id=&quot;input&quot;
                      rows=&quot;1&quot;
                      placeholder=&quot;×›×ª×•×‘ ×”×•×“×¢×”...&quot;
                      class=&quot;flex-1 bg-dark-bg border border-dark-border rounded-2xl p-4 resize-none max-h-40 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:border-transparent&quot;
                      style=&quot;min-height: 56px;&quot;&gt;&lt;/textarea&gt;
        &lt;/div&gt;
        &lt;button id=&quot;send&quot;
                class=&quot;bg-primary-blue hover:bg-hover-blue text-white px-6 py-3 rounded-2xl flex items-center justify-center transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed&quot;&gt;
            &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-6 w-6&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot;&gt;&lt;path d=&quot;M2.01 21L23 12 2.01 3 2 10l15 2-15 2z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;
        &lt;/button&gt;
    &lt;/footer&gt;

    &lt;!-- Scripts --&gt;
    &lt;script&gt;
        // --- Configuration and Constants ---
        const STORAGE_KEY_CHATS = &quot;gemini_royale_chats&quot;;
        const STORAGE_KEY_API_KEY = &quot;gemini_royale_api_key&quot;;
        const MAX_HISTORY_CHATS = 10; // ××¡×¤×¨ ×”×©×™×—×•×ª ×©×™×™×©××¨×•
        const DEFAULT_MODEL = &quot;gemini-2.5-flash&quot;;

        // --- DOM Elements ---
        const apiKeyInput = document.getElementById(&#39;apiKey&#39;);
        const toggleApiKeyVisibilityButton = document.getElementById(&#39;toggleApiKeyVisibility&#39;);
        const modelSelect = document.getElementById(&#39;model&#39;);
        const newChatButton = document.getElementById(&#39;newChat&#39;);
        const chatEl = document.getElementById(&#39;chat&#39;);
        const inputEl = document.getElementById(&#39;input&#39;);
        const sendButton = document.getElementById(&#39;send&#39;);
        const chatListEl = document.getElementById(&#39;chatList&#39;);

        // --- State Management ---
        let state = {
            chats: {},          // { chatId: { title: &quot;...&quot;, messages: [{ role: &quot;user&quot;, parts: [{ text: &quot;...&quot; }] }] } }
            currentChatId: null,
            isLoading: false,
            abortController: null,
            apiKey: &quot;&quot;,
            apiKeyHidden: true
        };

        // --- Utility Functions ---
        function $(selector) {
            return document.querySelector(selector);
        }
        function $$(selector) {
            return document.querySelectorAll(selector);
        }

        function sanitize(text) {
            if (typeof text !== &#39;string&#39;) return text;
            return text.replace(/[&amp;&lt;&gt;&quot;&#39;]/g, m =&gt; ({
                &#39;&amp;&#39;: &#39;&amp;amp;&#39;,
                &#39;&lt;&#39;: &#39;&amp;lt;&#39;,
                &#39;&gt;&#39;: &#39;&amp;gt;&#39;,
                &#39;&quot;&#39;: &#39;&amp;quot;&#39;,
                &quot;&#39;&quot;: &#39;&amp;#39;&#39;
            })[m]);
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY_CHATS, JSON.stringify(state.chats));
            localStorage.setItem(STORAGE_KEY_API_KEY, state.apiKey);
        }

        function loadState() {
            const savedChats = localStorage.getItem(STORAGE_KEY_CHATS);
            if (savedChats) {
                state.chats = JSON.parse(savedChats);
            }
            const savedApiKey = localStorage.getItem(STORAGE_KEY_API_KEY);
            if (savedApiKey) {
                state.apiKey = savedApiKey;
                apiKeyInput.value = state.apiKey;
                toggleApiKeyVisibility(state.apiKeyHidden); // ×œ×©××•×¨ ×¢×œ ××¦×‘ ×”×”×¡×ª×¨×” ×”×”×ª×—×œ×ª×™
            }
            // ×‘×—×¨ ××ª ×”×©×™×—×” ×”××—×¨×•× ×” ××• ×¦×•×¨ ×—×“×©×”
            const chatIds = Object.keys(state.chats);
            if (chatIds.length &gt; 0) {
                state.currentChatId = chatIds[0]; // ×‘×—×¨ ××ª ×”×©×™×—×” ×”×¨××©×•× ×” ×‘×¨×©×™××”
            } else {
                createNewChat();
            }
        }

        // --- Rendering Functions ---
        function renderChatList() {
            chatListEl.innerHTML = &#39;&#39;;
            const chatIds = Object.keys(state.chats).reverse(); // ×œ×”×¦×™×’ ××ª ×”×—×“×©×•×ª ×‘×™×•×ª×¨ ×œ××¢×œ×”

            chatIds.forEach(chatId =&gt; {
                const chatData = state.chats[chatId];
                const li = document.createElement(&#39;div&#39;);
                li.className = `chat-list-item ${chatId === state.currentChatId ? &#39;active&#39; : &#39;&#39;}`;
                li.textContent = chatData.title || `×©×™×—×” ${new Date(parseInt(chatId)).toLocaleDateString()}`; // ×›×•×ª×¨×ª ×‘×¨×™×¨×ª ××—×“×œ

                li.onclick = () =&gt; {
                    selectChat(chatId);
                };
                chatListEl.appendChild(li);
            });

            // Trim history if it exceeds max
            const currentChatIds = Object.keys(state.chats);
            if (currentChatIds.length &gt; MAX_HISTORY_CHATS) {
                const toRemove = currentChatIds.slice(0, currentChatIds.length - MAX_HISTORY_CHATS);
                toRemove.forEach(chatId =&gt; delete state.chats[chatId]);
                saveState();
            }
        }

        function renderMessages() {
            chatEl.innerHTML = &#39;&#39;; // × ×§×” ××ª ×”×ª×•×›×Ÿ ×”× ×•×›×—×™

            if (!state.currentChatId || !state.chats[state.currentChatId]) {
                chatEl.innerHTML = &#39;&lt;div class=&quot;flex justify-center items-center h-full text-gray-500&quot;&gt;×‘×—×¨ ×©×™×—×” ××• ×¦×•×¨ ×©×™×—×” ×—×“×©×”&lt;/div&gt;&#39;;
                return;
            }

            const currentChat = state.chats[state.currentChatId];

            currentChat.messages.forEach(message =&gt; {
                const wrapper = document.createElement(&quot;div&quot;);
                wrapper.className = `flex w-full ${message.role === &quot;user&quot; ? &quot;justify-end&quot; : &quot;justify-start&quot;}`;

                const bubble = document.createElement(&quot;div&quot;);
                bubble.className = `bubble ${message.role === &quot;user&quot; ? &quot;user&quot; : (message.error ? &quot;error&quot; : &quot;ai&quot;)}`;

                message.parts.forEach(part =&gt; {
                    if (part.text) {
                        const div = document.createElement(&quot;div&quot;);
                        // ×× ×–×” ×§×•×“, × ×¢×‘×“ ××•×ª×• ×¢× marked ×•××– × ×“×’×™×© ××•×ª×•
                        if (message.role === &quot;model&quot; &amp;&amp; part.text.trim().startsWith(&#39;```&#39;)) {
                            div.innerHTML = marked.parse(part.text); // marked ×™×¢×‘×“ ××ª ×”-Markdown
                            // ×œ××—×¨ ××›×Ÿ, × ×“××’ ×œ×”×“×’×™×© ××ª ×”×§×•×“
                            setTimeout(() =&gt; { // ×©×™××•×© ×‘-setTimeout ×›×“×™ ×œ×•×•×“× ×©×”-DOM ×¢×•×“×›×Ÿ
                                $$(&#39;pre code&#39;).forEach(block =&gt; {
                                    if (!block.classList.contains(&#39;hljs&#39;)) { // ×‘×“×•×§ ×× ×›×‘×¨ ×”×•×“×’×©
                                        hljs.highlightElement(block);
                                    }
                                });
                                addCopyButtons(); // ×”×•×¡×£ ×›×¤×ª×•×¨×™ ×”×¢×ª×§×”
                            }, 0);
                        } else {
                            // ×˜×§×¡×˜ ×¨×’×™×œ, ×”×—×œ×£ ×©×•×¨×•×ª ×—×“×©×•×ª ×‘-BR
                            div.innerHTML = sanitize(part.text).replace(/\n/g, &quot;&lt;br&gt;&quot;);
                        }
                        bubble.appendChild(div);
                    } else if (part.inline_data) {
                        // ×˜×™×¤×•×œ ×‘×ª××•× ×•×ª (×œ×¢×ª ×¢×ª×”, ×¨×§ ××¦×™×’ ××•×ª×Ÿ)
                        const img = document.createElement(&quot;img&quot;);
                        img.src = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
                        img.className = &quot;max-w-xs rounded-xl mt-3 border border-gray-700&quot;;
                        bubble.appendChild(img);
                    }
                    // × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××Ÿ ×˜×™×¤×•×œ ×‘×¡×•×’×™ ×—×œ×§×™× × ×•×¡×¤×™× ×× ×”-API ×™×ª××•×š ×‘×”×
                });

                wrapper.appendChild(bubble);
                chatEl.appendChild(wrapper);
            });

            // Scroll to bottom
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function renderLoadingIndicator() {
            if (!state.isLoading) return;

            const wrapper = document.createElement(&quot;div&quot;);
            wrapper.className = &quot;flex w-full justify-start&quot;;

            const bubble = document.createElement(&quot;div&quot;);
            bubble.className = &quot;bubble ai flex items-center gap-2&quot;; // ×§×¦×ª ×¨×™×•×•×—

            const indicator = document.createElement(&#39;span&#39;);
            indicator.className = &#39;loading-indicator&#39;;
            indicator.innerHTML = &#39;â³&#39;; // ××™×™×§×•×Ÿ ×©×œ ×©×¢×•×Ÿ ×—×•×œ, ××¤×©×¨ ×œ×©× ×•×ª ×œ×× ×™××¦×™×” ×¢× GIF ××• SVG
            bubble.appendChild(indicator);

            const text = document.createElement(&#39;span&#39;);
            text.textContent = &quot;×—×•×©×‘...&quot;;
            bubble.appendChild(text);

            wrapper.appendChild(bubble);
            chatEl.appendChild(wrapper);
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function addCopyButtons() {
            $$(&#39;pre&#39;).forEach(preElement =&gt; {
                if (!preElement.querySelector(&#39;.copy-button&#39;)) { // ×‘×“×•×§ ×× ×”×›×¤×ª×•×¨ ×›×‘×¨ ×§×™×™×
                    const copyButton = document.createElement(&#39;button&#39;);
                    copyButton.className = &#39;copy-button&#39;;
                    copyButton.textContent = &#39;×”×¢×ª×§&#39;;
                    copyButton.onclick = () =&gt; {
                        const codeBlock = preElement.querySelector(&#39;code&#39;);
                        if (codeBlock) {
                            navigator.clipboard.writeText(codeBlock.textContent)
                                .then(() =&gt; {
                                    copyButton.textContent = &#39;×”×•×¢×ª×§!&#39;;
                                    setTimeout(() =&gt; {
                                        copyButton.textContent = &#39;×”×¢×ª×§&#39;;
                                    }, 2000);
                                })
                                .catch(err =&gt; {
                                    console.error(&#39;Failed to copy: &#39;, err);
                                    copyButton.textContent = &#39;×©×’×™××”!&#39;;
                                    setTimeout(() =&gt; {
                                        copyButton.textContent = &#39;×”×¢×ª×§&#39;;
                                    }, 2000);
                                });
                        }
                    };
                    preElement.appendChild(copyButton);
                }
            });
        }


        // --- Chat Management Functions ---
        function createNewChat() {
            const chatId = Date.now().toString();
            state.chats[chatId] = {
                title: `×©×™×—×” ${Object.keys(state.chats).length + 1}`, // ×›×•×ª×¨×ª ×–×× ×™×ª
                messages: []
            };
            state.currentChatId = chatId;
            saveState();
            render();
            renderChatList(); // ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”×©×™×—×•×ª
            inputEl.focus(); // ×”×—×–×¨ ×¤×•×§×•×¡ ×œ×©×“×” ×”×§×œ×˜
        }

        function selectChat(chatId) {
            if (state.currentChatId === chatId) return;
            state.currentChatId = chatId;
            saveState();
            render();
            renderChatList();
        }

        function deleteChat(chatId) {
            if (!state.chats[chatId]) return;
            delete state.chats[chatId];
            if (state.currentChatId === chatId) {
                // ×× ×”×©×™×—×” ×”× ×•×›×—×™×ª × ××—×§×”, ×‘×—×¨ ×©×™×—×” ××—×¨×ª ××• ×¦×•×¨ ×—×“×©×”
                const chatIds = Object.keys(state.chats);
                state.currentChatId = chatIds.length &gt; 0 ? chatIds[0] : null;
                if (!state.currentChatId) {
                    createNewChat(); // ×× ××™×Ÿ ×™×•×ª×¨ ×©×™×—×•×ª, ×¦×•×¨ ×—×“×©×”
                }
            }
            saveState();
            render();
            renderChatList();
        }

        // --- API Interaction ---
        async function sendMessage() {
            if (state.isLoading) return; // ×œ×× ×•×¢ ×©×œ×™×—×” ×›×¤×•×œ×”

            const text = inputEl.value.trim();
            if (!text) return;

            // ×‘×“×™×§×ª API Key
            if (!state.apiKey) {
                alert(&quot;×× × ×”×–×Ÿ ××ª ×”-API Key ×©×œ×š.&quot;);
                return;
            }

            // ×™×¦×™×¨×ª ×©×™×—×” ×—×“×©×” ×× ×œ× ×§×™×™××ª
            if (!state.currentChatId || !state.chats[state.currentChatId]) {
                createNewChat();
            }

            const currentChat = state.chats[state.currentChatId];

            // ×”×•×¡×¤×ª ×”×•×“×¢×ª ××©×ª××©
            currentChat.messages.push({
                role: &quot;user&quot;,
                parts: [{ text: text }]
            });

            inputEl.value = &quot;&quot;; // × ×™×§×•×™ ×©×“×” ×”×§×œ×˜
            state.isLoading = true;
            sendButton.disabled = true;
            render(); // ×”×¦×’ ××ª ×”×•×“×¢×ª ×”××©×ª××©
            renderLoadingIndicator(); // ×”×¦×’ ××™× ×“×™×§×˜×•×¨ ×˜×¢×™× ×”

            // ×™×¦×™×¨×ª AbortController ×—×“×© ×œ×‘×™×˜×•×œ ×”×‘×§×©×” ×× ×¦×¨×™×š
            if (state.abortController) {
                state.abortController.abort();
            }
            state.abortController = new AbortController();

            try {
                const model = modelSelect.value;
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${state.apiKey}`,
                    {
                        method: &quot;POST&quot;,
                        headers: { &quot;Content-Type&quot;: &quot;application/json&quot; },
                        body: JSON.stringify({
                            contents: currentChat.messages.map(m =&gt; ({ role: m.role, parts: m.parts }))
                        }),
                        signal: state.abortController.signal
                    }
                );

                // ×”×¡×¨×ª ××™× ×“×™×§×˜×•×¨ ×”×˜×¢×™× ×” (×”×•× ×™×•×—×œ×£ ×‘×ª×’×•×‘×ª ×”-AI)
                $$(&#39;.loading-indicator&#39;).forEach(el =&gt; el.remove());

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `×©×’×™××” HTTP ${response.status}`;
                    if (errorData.error &amp;&amp; errorData.error.message) {
                        errorMessage += `: ${errorData.error.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                // ×”×˜×™×¤×•×œ ×‘×ª×’×•×‘×” ××”-API
                const modelResponse = data.candidates?.[0]?.content?.parts?.[0];

                if (!modelResponse) {
                    throw new Error(&quot;×”×ª×’×•×‘×” ××”-API ××™× ×” ××›×™×œ×” ×ª×•×›×Ÿ ×¦×¤×•×™.&quot;);
                }

                let aiMessage = { role: &quot;model&quot;, parts: [] };

                if (modelResponse.text) {
                    aiMessage.parts.push({ text: modelResponse.text });
                } else if (modelResponse.inline_data) {
                    // ××•×“×œ×™× ×›××• Gemini Flash Image ×™×›×•×œ×™× ×œ×”×—×–×™×¨ ×ª××•× ×•×ª
                    aiMessage.parts.push({
                        inline_data: {
                            mime_type: modelResponse.inline_data.mime_type,
                            data: modelResponse.inline_data.data
                        }
                    });
                } else {
                    // ×× ××™×Ÿ ×˜×§×¡×˜ ×•××™×Ÿ inline_data, ×™×›×•×œ ×œ×”×™×•×ª ×©××“×•×‘×¨ ×‘××‘× ×” ××—×¨ ××• ×‘×©×’×™××”
                    console.warn(&quot;Model response part has no text or inline_data:&quot;, modelResponse);
                    aiMessage.parts.push({ text: &quot;×”×ª×§×‘×œ×” ×ª×’×•×‘×” ×‘×¤×•×¨××˜ ×œ× ××•×›×¨.&quot; });
                }

                // ×”×•×¡×¤×ª ×”×•×“×¢×ª ×”-AI ×œ×ª×’×•×‘×•×ª
                currentChat.messages.push(aiMessage);


            } catch (err) {
                console.error(&quot;API Error:&quot;, err);
                // ×”×•×¡×¤×ª ×”×•×“×¢×ª ×©×’×™××”
                currentChat.messages.push({
                    role: &quot;model&quot;,
                    parts: [{ text: &quot;×©×’×™××”: &quot; + err.message }],
                    error: true
                });
            } finally {
                state.isLoading = false;
                sendButton.disabled = false;
                state.abortController = null; // × ×§×” ××ª ×”×‘×§×¨
                saveState(); // ×©××•×¨ ××ª ×”×”×™×¡×˜×•×¨×™×”
                render(); // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×” ×¢× ×ª×’×•×‘×ª ×”-AI ××• ×”×©×’×™××”
            }
        }

        // --- Event Listeners ---
        sendButton.onclick = sendMessage;

        inputEl.addEventListener(&quot;keydown&quot;, e =&gt; {
            if (e.key === &quot;Enter&quot; &amp;&amp; !e.shiftKey) {
                e.preventDefault(); // ×× ×¢ ×”×–×—×ª ×©×•×¨×” ×—×“×©×”
                sendMessage();
            }
            // ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×˜×™×¤×•×œ ×‘-Shift+Enter ×œ×”×–×—×ª ×©×•×¨×”
        });

        newChatButton.onclick = createNewChat;

        apiKeyInput.oninput = () =&gt; {
            state.apiKey = apiKeyInput.value.trim();
            // Optionally save immediately if you want it to persist across refreshes without explicit save
            // saveState();
        };

        function toggleApiKeyVisibility(forceHide = null) {
            const isHidden = forceHide !== null ? forceHide : !state.apiKeyHidden;
            state.apiKeyHidden = isHidden;
            apiKeyInput.type = isHidden ? &quot;password&quot; : &quot;text&quot;;
            toggleApiKeyVisibilityButton.textContent = isHidden ? &quot;ğŸ‘ï¸&quot; : &quot;ğŸ™ˆ&quot;;
        }

        toggleApiKeyVisibilityButton.onclick = () =&gt; toggleApiKeyVisibility();

        // --- Initialization ---
        function initialize() {
            loadState();
            render();
            renderChatList();
            toggleApiKeyVisibility(state.apiKeyHidden); // ×•×“× ×©×”-API key ××•×¡×ª×¨ ×‘×”×ª×× ×œ××¦×‘
            hljs.highlightAll(); // ×œ×”×“×’×©×ª ×§×•×“ ×× ×™×© ×“×‘×¨×™× ×©× ×˜×¢× ×• ××¨××©
            addCopyButtons(); // ×œ×”×•×¡×¤×ª ×›×¤×ª×•×¨×™ ×”×¢×ª×§×” ×× ×™×© ×§×•×“ ×‘×˜×¢×™× ×” ×¨××©×•× ×™×ª
            inputEl.focus(); // ×”×¦×‘ ×¤×•×§×•×¡ ×¢×œ ×©×“×” ×”×§×œ×˜ ×‘×¢×ª ×˜×¢×™× ×”
        }

        // --- Run Initialization ---
        document.addEventListener(&#39;DOMContentLoaded&#39;, initialize);

    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
